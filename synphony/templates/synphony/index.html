{% extends 'synphony/base.html' %}
{% block extrajs %}
{% load static %}
<script src="{% static 'js/reconnecting-websocket.js' %}"></script>
<script src="{% static 'js/song_operation.js' %}"></script>
<script src="{% static 'js/websocketbridge.js' %}" type="text/javascript"></script>
<!-- <script src="{% static 'js/comments.js' %}" type="text/javascript"></script> -->
<script src="{% static 'js/playlistwebsocket.js' %}" type="text/javascript"></script>
<style type="text/css">
    body {
        background-image: url('{% static "media/homepage.jpg" %}');
        background-size: 1450px 690px;
    }
</style>
{% endblock extrajs%}
{% block title %}Studio{% endblock title%}
{% block main %}


<div class="col-8">
{% if isHost %}
<form  method = "POST">
    {% csrf_token %}
    <button class="btn btn-dark" style="float: right; width: 7%;"id="song-name-submit" name="song-name-submit" type="submit"/>Get</button>

    <input style="width:90%;"id="song-name" name="song-name" type="text" size="100" placeholder="Search by typing song titles" required><br/>

</form>
<!-- Below is the search result -->
<div class="search-box-result-wrapper" style="height:20%; overflow-y: scroll; margin-top: 3%;">
    {% for song in list %}
	<div class="row m-1">
		<div class="col-10">
			<li id="{{song.id}}">{{song.name}}, by: {{song.ar}} </li>
		</div>
		<div class="col-2">
			<button class="btn btn-dark" style="float: right;" name="song-name-add"  value="{{song.id}}"> Add </button>
		</div>
    </div>
	{% endfor %}
</div>
<br>
{% endif %}
<!-- Audio -->
<!--<audio controls autoplay controller class="audio" id="music-bar" style="width: 100%;margin-bottom: 4%;">
        <source id="audiosrc" src="https://m8.music.126.net/20191103122027/29fb188753b59507e8a6ea5e02d7c6be/ymusic/5459/0352/535b/c32298577948180f7c1ed1dd811d4077.mp3" type="audio/mpeg">
          Your browser does not support the audio element.
</audio>-->
<audio {% if isHost %}controls{% endif %} autoplay controller class="audio audio-control" data-isHost="{{ isHost }}" id="music-bar", src="">
	<source id="audiosrc" src="" type="audio/mpeg">
	Your browser does not support the audio element.
</audio>

{% if not isHost %}
<button type="button" class="btn btn-dark my-2" id="start-btn" onclick=start_playing(this)>Start</button>
{% else %}
<button type="button" class="btn btn-dark my-2" id="close-btn" onclick=close_studio(this)>Close</button>
<button type="button" class="btn btn-dark my-2" id="playall-btn" value="loop" onclick="play_all(this.value)">Play all</button>
<button type="button" class="btn btn-dark my-2" id="playall-btn" value="shuffle" onclick="play_all(this.value)">Shuffle all</button>
{% endif %}

<!-- Below is the playlist of the studio -->
<table  class="table table-bordered"  id="myTable" style="color: white;">
	<tbody>
	<!-- NEED TO CHANGE BY NICOLE -->
	{% csrf_token %}
	{% for music in musics %}
	<tr>
		{% if isHost %}
		<td> <div class = "to_right" onclick=playMusic(this.id) id="{{music.url}}" value="{{music.url}}"> </div> </td>
		{% endif %}

		<td>{{music.name}}</td>
		<td>{{music.description}}</td>

		{% if isHost %}
		<td>
			<button class="btn btn-dark"  name="remove_song" value="{{music.id}}" value="{{music.id}}" name="remove_song">Remove</button>
		</td>
		{% endif %}

		<td>
			<button class="btn btn-dark" name="song" value="{{music.id}}"  data-id="{{music.id}}"
				onclick=likeSongs(this)>{% if user in music.liked_user.all %}Unlike{% else %}Like{% endif %}</button>
		</td>
	</tr>
	{% endfor %}
		<!-- {{show}} -->
	</tbody>
</table>

  </div>
  <div id="commenthere" style="float: right; height:50%; border-left: 50px;" class="col-4">
        <div id="commentcontent" style="width: 100%; overflow-y: scroll;">
        </div>
        <br>
        <textarea id = "commentinput" style="width: 100%;" name="commentinput">
        </textarea>
        <br>
        <button class="btn btn-dark" id="postComment" name="postComment" style="width: 100%;">post</button>
</div>

<script>
    var key = {{ key_json }}; //studio hashed key
   // open new sockect
   
    var chat_scheme = window.location.protocol == "https:" ? "wss" : "ws";
    var chatSocket = new ReconnectingWebSocket(
        chat_scheme + '://' + window.location.host +
        '/ws/synphony/' + key + '/');

    // append comment history
    chatSocket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        var message = data['message'];
        console.log("message received: " + message)
        document.querySelector('#commentcontent').innerHTML += (message +  "<br />");
    };

    //disonnect
    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    // post comment
    document.querySelector('#commentinput').focus();
    document.querySelector('#commentinput').onkeyup = function(e) {
        if (e.keyCode === 13) {  // enter, return
            document.querySelector('#postComment').click();
        }
    };

    document.querySelector('#postComment').onclick = function(e) {
        var messageInputDom = document.querySelector('#commentinput');
        var message = messageInputDom.value;
        var user = "{{user.username}}: ";
        console.log(user)
        chatSocket.send(JSON.stringify({
            'message': user + message
        }));

        console.log(message + " sent!")
        messageInputDom.value = '';
    };
</script>
{% endblock main %}

